{% extends 'app/base.html' %}

{% block content %}
{% if messages %}
    <div id="popup-messages" style="position: fixed; top: 1rem; right: 1rem; z-index: 9999;">
        {% for message in messages %}
            <div class="message-popup {{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

<div class="container mt-5">
    <form method="post" class="form-class" enctype="multipart/form-data">
        <h2>Edytuj dane {{ notification.name }}</h2>

        {% csrf_token %}
        {{ form.as_p }}

        {% if form.non_field_errors %}
            <div class="form-errors">
                {% for error in form.non_field_errors %}
                    <p class="error-text">- {{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Map for location -->
        <div class="mb-3">
            <label class="form-label">Lokalizacja</label>
            {% if form.latitude.errors or form.longitude.errors %}
                <div class="form-errors">
                    <p class="error-text">Proszę zaznacz gdzie ostatnio widziano twojego pupila!</p>
                </div>
            {% endif %}
            <div id="leaflet-map" style="height: 300px;"></div>
        </div>

        <!-- Image preview -->
        {% if notification.image %}
            <p style="margin-top: 1em; display: flex; flex-direction: column;">Aktualne zdjęcie: <img style="border-radius: 28px; margin-top: 0.25em;" src="{{ notification.image.url }}" alt="{{ notification.name }}" style="max-width: 100px;"></p>
        {% endif %}

        <button type="submit">Zapisz zmiany</button>
        <p style="margin-top: 1.5rem; text-align: center;">
            <a href="{% url 'account' %}">Anuluj</a>
        </p>
    </form>

    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var map = L.map('leaflet-map').setView([{{ notification.latitude }}, {{ notification.longitude }}], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        var marker = L.marker([{{ notification.latitude }}, {{ notification.longitude }}], { draggable: true }).addTo(map);
        marker.on('dragend', function(e) {
            var coords = e.target.getLatLng();
            document.getElementById('id_latitude').value = coords.lat.toFixed(6);
            document.getElementById('id_longitude').value = coords.lng.toFixed(6);
        });
        map.on('click', function(e) {
            marker.setLatLng(e.latlng);
            document.getElementById('id_latitude').value = e.latlng.lat.toFixed(6);
            document.getElementById('id_longitude').value = e.latlng.lng.toFixed(6);
        });
        document.getElementById('id_latitude').value = {{ notification.latitude }};
        document.getElementById('id_longitude').value = {{ notification.longitude }};
    </script>

    <script>
        document.querySelectorAll(".message-popup").forEach(el => {
            // Click to dismiss with animation
            el.addEventListener("click", () => {
                el.classList.add("fade-out");
                setTimeout(() => el.remove(), 500);
            });

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                el.classList.add("fade-out");
                setTimeout(() => el.remove(), 500);
            }, 5000);
        });
    </script>
</div>
{% endblock %}